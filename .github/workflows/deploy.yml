name: Deploy Airflow to EC2

on:
    push:
        branches:
        - develop
        - feat/github-action-hyerim

env:
    PROJECT_DIR: /home/ec2-user/airflow_project
    WORKER_IPS: ${{ secrets.WORKER1_PRIVATE_IP }} ${{ secrets.WORKER2_PRIVATE_IP }} ${{ secrets.WORKER3_PRIVATE_IP }}

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
    
            - name: Set up SSH
              uses: webfactory/ssh-agent@v0.5.3
              with:
                ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
            - name: Add known hosts
              run: |
                echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

            - name: Sync Master Node
              run: |
                ssh ec2-user@${{ secrets.MASTER_IP }} "mkdir -p $PROJECT_DIR"
                rsync -avz ./ ec2-user@${{ secrets.MASTER_IP }}:$PROJECT_DIR

            - name: Copy Airflow Project to Worker Nodes
              run: |
                for WORKER_IP in $WORKER_IPS; do
                  ssh -A ec2-user@${{ secrets.MASTER_IP }} "ssh ec2-user@$WORKER_IP 'mkdir -p $PROJECT_DIR'"
                  ssh -A ec2-user@${{ secrets.MASTER_IP }} "rsync -avz $PROJECT_DIR/ ec2-user@$WORKER_IP:$PROJECT_DIR/"
                done

            - name: Deploy to Worker Nodes (Docker Run)
              run: |
                for WORKER_IP in $WORKER_IPS; do
                  ssh -A ec2-user@${{ secrets.MASTER_IP }} "
                    ssh ec2-user@$WORKER_IP '
                      docker stop airflow-worker || true &&
                      docker rm airflow-worker || true &&
                      docker run -d --name airflow-worker airflow-worker
                    '
                  "
                done
              
            - name: Start Airflow on Master
              run: |
                ssh ec2-user@${{ secrets.MASTER_IP }} "
                    cd $PROJECT_DIR/airflow &&
                    docker-compose down &&
                    docker-compose up -d &&
                    docker-compose exec -T airflow-webserver airflow db upgrade &&
                    docker-compose restart
                "